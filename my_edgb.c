
void edgb_KS_func(double X[NDIM], double edgb_KS[NDIM][NDIM])
{
  memset(edgb_KS, 0, NDIM*NDIM*sizeof(double));

  #if METRIC == MINKOWSKI
  edgb_KS[0][0] = -1.;
  for (int j = 1; j < NDIM; j++) {
    edgb_KS[j][j] = 1.;
  }
  
  #else //Everything else is covered in set_dxdX
  double sth, cth, c2t, c4t, s2t, rho2, ep2, ep4, epsilon, zeta;
  double r, th;

  bl_coord(X, &r, &th); // its calling bl coordinates? 

  cth = cos(th);
  sth = sin(th);

  s2t = sth*sth;
  c2t = cth*cth ;
  c4t = c2t*c2t;
  ep2 = epsilon*epsilon; 
  ep4 = ep2*ep2;


  edgb_KS[0][0] = -1 + 2/r - (2*ep2*c2t)/pow(r,3) + 2*ep4*c4t/pow(r,5) + zeta*(-1./15.*(-400.+96.*r+66.*pow(r,2.)+130.*pow(r,3.)+5.*pow(r,4.))/pow(r,7.)
    + (ep2*(pow(r,7.)*(444696.-562338.*c2t)  + 8820000.*(-1. + 3.*c2t) - 19600.*r*(-467. + 1251.*c2t) - 63.*pow(r,8.)*(-3267. + 8926.*c2t) 
    + 1050.*pow(r,3.)*(-1465. + 11997.*c2t) - 2100.*pow(r,2.)*(-955. + 22577.*c2t) - 6.*pow(r,6.)*(-59329. + 82437.*c2t) + 15.*pow(r,5.)*(-52533. + 455029.*c2t) 
    + 10.*pow(r,4.)*(-281221. + 1218513.*c2t)))/(110250.*pow(r,11.)) + (ep4*(675.*pow(r,12.)*(-19717. + 67726.*c2t) + 450.*pow(r,11.)*(43312. + 101589.*c2t) 
    - 164640000.*(-70. + 585.*c2t + 156.*c4t) - 8232000.*r*(3949. - 11058.*c2t + 6948.*c4t) - 39200.*pow(r,2.)*(189191. - 824825.*c2t + 972045.*c4t) 
    + 60.*pow(r,9.)*(717867. - 13885852.*c2t + 12733507.*c4t) + 30.*pow(r,10.)*(209773. - 9090216.*c2t + 16888370.*c4t) + 1400.*pow(r,3.)*(648009. - 14691730.*c2t 
    + 26074500.*c4t) + 420.*pow(r,4.)*(553219.- 32471380.*c2t + 222891320.*c4t) - 14.*pow(r,7.)*(-11393603. + 38599350.*c2t + 359928985.*c4t) 
    + 2.*pow(r,8.)*(59964679. - 491173980.*c2t + 452824800.*c4t) - 28.*pow(r,5.)*(21852807. + 12094180.*c2t + 762315255.*c4t) 
    - 14.*pow(r,6.)*(42004007. - 226439060.*c2t + 1041312310.*c4t)))/(30870000.*pow(r,15.)));

  edgb_KS[0][1] = 2/r - (2*ep2*c2t)/pow(r,3) + (2*ep4*c4t)/pow(r,5) + zeta*(-1./30.*(-800. + 912.*r + 516.*pow(r,2.) + 470.*pow(r,3.) + 50.*pow(r,4.) + 15.*pow(r,5.))/ pow(r,7.) 
    + (ep2*(-566034*pow(r,8) + 55125*pow(r,9) +  17640000*(-1 + 3*c2t) + 12600*pow(r,3)*(4006 + 1877*c2t) + 78400*r*(-779 + 2412*c2t) + 42*pow(r,7)*(-94339 
    + 107112*c2t) - 1400*pow(r,2)*(20431 + 132243*c2t) + 36*pow(r,6)*(-436917 + 491281*c2t) + 20*pow(r,4)*(-875941 + 2263053*c2t) + 20*pow(r,5)*(-1122937 
    + 2632446*c2t)))/(220500*pow(r,11)) - (ep4*(-80247150*pow(r,12) - 5788125*pow(r,13) + 450*pow(r,11)*(-1196839 + 812712*c2t) 
    + 329280000*(-70 + 585*c2t + 156*c4t) + 49392000*r*(-1717 + 21664*c2t + 9076*c4t) + 60*pow(r,10)*(-23601289 + 13406112*c2t + 2187250*c4t) 
    + 78400*pow(r,2)*(-2206069 - 11318105*c2t + 13657725*c4t) + 14000*pow(r,3)*(22540153 - 88517480*c2t + 62290230*c4t) 
    + 30*pow(r,9)*(-145291221 + 30934768*c2t + 146683252*c4t) + 280*pow(r,4)*(793805393 - 2014699860*c2t + 507428040*c4t) 
    + 28*pow(r,6)*(-711534337 - 1340707620*c2t + 4191169150*c4t) + 28*pow(r,5)*(2484408549 - 2498856340*c2t + 4680981810*c4t) 
    + 14*pow(r,7)*(-1576790517 - 1991632680*c2t + 4890821060*c4t) + 4*pow(r,8)*(-2741883352 - 2122491690*c2t + 5145464715*c4t)))/(61740000*pow(r,15)));

  edgb_KS[0][3] = (2*epsilon*(-1 + c2t))/r - (2*epsilon*ep2*c2t*(-1 + c2t))/pow(r,3) + zeta*(-1./15.*((-400. + 144.*r + 90.*pow(r,2.) + 140.*pow(r,3.) 
    + 9.*pow(r,4.))*epsilon*(-1. + c2t))/pow(r,7.) - (ep2*epsilon*(-1 + c2t)* (pow(r,4)*(2736210 - 4410530*c2t) + pow(r,5)*(766015 - 3620183*c2t) - 
    8820000*(-1 + 3*c2t) + 19600*r*(-467 + 1551*c2t) - 12*pow(r,6)*(26511 +  6310*c2t) + 750*pow(r,3)*(2051 + 8733*c2t) +  2100*pow(r,2)*(-955 + 21233*c2t) 
    + 3*pow(r,8)*(-63529 + 262520*c2t) + pow(r,7)*(-406611 + 563055*c2t)))/(110250*pow(r,11)));

  edgb_KS[1][0] = edgb_KS[0][1];

  edgb_KS[1][1] =  (2 + r)/r - (2*ep2*c2t)/pow(r,3) + (2*ep4*c4t)/pow(r,5) + zeta*(-1./15.*(-400. + 816.*r + 450.*pow(r,2.) + 340.*pow(r,3.) + 45.*pow(r,4.) + 15.*pow(r,5.))/pow(r,7.) 
    + (ep2*(55125*pow(r,9) + 8820000*(-1 + 3*c2t) + 1050*pow(r,3)*(49537 + 10527*c2t) + 19600*r*(-3583 + 10899*c2t) + 21*pow(r,8)*(-36755 + 26778*c2t) 
    + 42*pow(r,7)*(-104927 + 120501*c2t) - 700*pow(r,2)*(43727 + 196755*c2t) + 6*pow(r,6)*(-2680831 + 3030123*c2t) + 10*pow(r,4)*(-1470661 + 3307593*c2t) 
    + 5*pow(r,5)*(-4334149 + 9164697*c2t)))/(110250*pow(r,11)) - (ep4*(-5788125*pow(r,13) + 225*pow(r,12)*(-415805 + 203178*c2t) 
    + 1350*pow(r,11)*(-384509 + 304767*c2t) + 164640000*(-70 + 585*c2t + 156*c4t) + 8232000*r*(-14251 + 141042*c2t + 47508*c4t) 
    + 30*pow(r,10)*(-46992805 + 17722008*c2t + 21262870*c4t) + 39200*pow(r,2)*(-4601329 - 21811385*c2t + 26343405*c4t) 
    + 30*pow(r,9)*(-143855487 + 3163064*c2t + 172150266*c4t) + 1400*pow(r,3)*(226049539 - 899866530*c2t + 648976800*c4t) 
    + 140*pow(r,4)*(1589270443 - 4126813860*c2t + 1683530040*c4t) + 10*pow(r,8)*(-1084760405 - 947231472*c2t + 2148750846*c4t) 
    + 28*pow(r,5)*(2462555742 - 2510950520*c2t + 3918666555*c4t) + 14*pow(r,7)*(-1565396914 - 2030232030*c2t + 4530892075*c4t) 
    + 14*pow(r,6)*(-1465072681 - 2454976180*c2t + 7341025990*c4t)))/(30870000*pow(r,15)));

  edgb_KS[1][3] =  ((2 + r)*epsilon*(-1 + c2t))/r - (2*epsilon*ep2*c2t*(-1 + c2t))/pow(r,3) + zeta*(-1./36750.*((16660000. - 5350800.*r + 4797450.*pow(r,2.) + 3526600.*pow(r,3.) 
    + 2965560.*pow(r,4.) + 918855.*pow(r,5.) + 187446.*pow(r,6.))*epsilon*(-1. + c2t))/pow(r,7.) + (epsilon*ep2*(-1 + c2t)*(22085775*pow(r,9) 
    + 4571505*pow(r,10) + 49392000*(580 + 327*c2t) + 548800*r*(-23041 + 74715*c2t) + 6300*pow(r,3)*(-446807 + 973501*c2t) 
    + 126*pow(r,7)*(1064483 + 1485790*c2t) + 9800*pow(r,2)*(-1223527 + 1991748*c2t) + 12*pow(r,8)*(4458631 + 3456783*c2t) 
    + 280*pow(r,4)*(3773463 + 15733496*c2t) + 42*pow(r,6)*(6767669 + 23527525*c2t) + 56*pow(r,5)*(17855552 + 49207893*c2t)))/(3087000*pow(r,11)));

  edgb_KS[2][2] = pow(r,2) + ep2*c2t + ((8820000 - 6213200*r - 3416700*pow(r,2) - 1855650*pow(r,3) + 887110*pow(r,4) + 800733*pow(r,5) + 435540*pow(r,6) 
   + 187446*pow(r,7))*ep2*zeta*(1 - 3*c2t))/(110250*pow(r,8)) + (ep4*zeta*(45715050*pow(r,11)*(-1 + 3*c2t) + 5625*pow(r,10)*(-20749 + 58131*c2t) 
   + 493920000*(-70 + 585*c2t + 156*c4t) + 24696000*r*(3049 - 10698*c2t + 8868*c4t) + 117600*pow(r,2)*(280331 - 1711445*c2t + 1596165*c4t) 
   + 180*pow(r,9)*(-1286466 - 846865*c2t + 5819941*c4t) + 4200*pow(r,3)*(2362411 - 16650910*c2t + 14489100*c4t) 
   - 1260*pow(r,4)*(-3173281 - 5026080*c2t + 26477920*c4t) + 42*pow(r,8)*(-18071967 - 940590*c2t + 54146980*c4t) 
   + 42*pow(r,6)*(-19116713 - 46592740*c2t + 138130070*c4t) - 28*pow(r,5)*(11804979 - 261030540*c2t + 235282135*c4t) 
   + 6*pow(r,7)*(-259078241 - 99440670*c2t + 857000595*c4t)))/(92610000*pow(r,12));

  edgb_KS[3][0] = edgb_KS[0][3];

  edgb_KS[3][1] = edgb_KS[1][3];

  edgb_KS[3][3] = -(pow(r,2)*(-1 + c2t)) - (ep2*(2 + r - 2*c2t)*(-1 + c2t))/r - (2*ep4*c2t*pow((-1 + c2t),2))/pow(r,3) 
    + zeta*(((8820000. - 6213200.*r - 3416700.*pow(r,2.) - 1855650.*pow(r,3.) + 887110.*pow(r,4.) + 800733.*pow(r,5.) + 435540.*pow(r,6.) 
    + 187446.*pow(r,7.))*ep2* (-1. + c2t)*(-1. + 3.*c2t))/(110250.*pow(r,8.)) -  (ep4*(-1 + c2t)*(45715050*pow(r,11)*(-1 + 3*c2t) 
    + 5625*pow(r,10)*(-20749 + 58131*c2t) + 493920000*(-70 + 585*c2t + 156*c4t) + 24696000*r*(3649 - 8958*c2t + 6528*c4t) 
    + 352800*pow(r,2)*(84857 - 350495*c2t + 320655*c4t) + 12600*pow(r,3)*(-82303 - 1443030*c2t + 1592200*c4t) 
    + 180*pow(r,9)*(-411718 - 4345857*c2t + 8444185*c4t) - 1260*pow(r,4)*(1578719 - 11450880*c2t + 28150720*c4t) 
    + 42*pow(r,8)*(-1863327 - 67980150*c2t + 104977900*c4t) + 28*pow(r,5)*(-14247879 - 109560360*c2t + 137751665*c4t) 
    + 42*pow(r,6)*(30654807 - 316973820*c2t + 358739630*c4t) + 6*pow(r,7)*(-25024421 - 1143700950*c2t + 1667207055*c4t)))/(92610000*pow(r,12)));

  // Apply coordinate transformation to code coordinates X
  double dxdX[NDIM][NDIM];
  set_dxdX(X, dxdX);

  double edgb_KS_odf[NDIM][NDIM]; 
  memcpy(edgb_KS_old, edgb_KS, NDIM*NDIM*sizeof(double));
  memset(edgb_KS, 0, NDIM*NDIM*sizeof(double));

  for (int mu = 0; mu < NDIM; mu++) {
    for (int nu = 0; nu < NDIM; nu++) {
      for (int lam = 0; lam < NDIM; lam++) {
        for (int kap = 0; kap < NDIM; kap++) {
          edgb_KS[mu][nu] += edgb_KS_old[lam][kap]*dxdX[lam][mu]*dxdX[kap][nu];
        }
      }
    }
  }
  #endif // METRIC
}

